<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CSRF token, if your plugin need to make POST request to backend -->
    <meta name="zoraxy.csrf.Token" content="{{.csrfToken}}">
    <link rel="stylesheet" href="/script/semantic/semantic.min.css">
    <script src="/script/jquery-3.6.0.min.js"></script>
    <script src="/script/semantic/semantic.min.js"></script>
    <script src="/script/utils.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/main.css">
    <title>Fail2Ban</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background:none;
        }
    </style>
</head>
<body>
    <!-- Dark theme script must be included after body tag-->
    <link rel="stylesheet" href="/darktheme.css">
    <script src="/script/darktheme.js"></script>
    <div style="display:flex;flex-direction:column;width:80%;height:100vh">
        <div style="display:flex;flex-direction:column;text-align: center">
            <h1>Fail2Ban Plugin</h1>
            <p>Welcome to the Fail2Ban plugin.</p>
            <p>Here you can see current IPs banned by Fail2ban as well as reconfigure fail2ban itself.</p>
            <textarea id="statusfield" disabled style="width:100%;height:200px"></textarea>
            <button class="ui button primary" id="refreshStatusButton">Refresh</button>
            <div>
                <p>Manually add or remove banned IPs to fail2ban.</p>
                <div class="ui form" style="display:flex;margin:5px">
                    <div class="field" style="width:100%;margin:0px 5px 0px 0px;align-self: center;">
                        <input type="text" id="banIpInput" placeholder="IP">
                    </div>
                    <button class="ui button primary" style="width:20%" id="banIPButton">Ban IP</button>
                </div>
                <div class="ui form" style="display:flex;margin:5px">
                    <div class="field" style="width:100%;margin:0px 5px 0px 0px;align-self: center;">
                        <input type="text" id="unbanIpInput" placeholder="IP">
                    </div>
                    <button class="ui button primary" style="width:20%" id="unbanIPButton">Unban IP</button>
                </div>
            </div>
        </div>
        <div style="display:flex;flex-direction:column;text-align: center;margin-top:1rem">
            <h2>Filter Config</h2>
            <p>Here you can change the filter configuration for reading the Zoraxy logs.</p>
            <textarea id="filterconfig" style="width:100%;height:150px"></textarea>
            <button class="ui button primary" id="updateFilterConfigRequestButton">Update</button>
        </div>
        <div style="display:flex;flex-direction:column;text-align: center;margin-top:1rem">
            <h2>Jail Config</h2>
            <p>Here you can change the jail configuration for reading the Zoraxy logs.</p>
            <textarea id="jailconfig" style="width:100%;height:150px"></textarea>
            <button class="ui button primary" id="updateJailConfigRequestButton">Update</button>
        </div>
    </div>
	
	<script>
		document.getElementById('refreshStatusButton').addEventListener('click', updateStatus);

		document.getElementById('updateFilterConfigRequestButton').addEventListener('click', function() {
			$.cjax({
				url: `./api/filter`,
				type: 'POST',
                contentType: 'text/html',
                data: document.getElementById('filterconfig').value,
				success: function(data) {
					updateStatus();
				},
				error: function(xhr, status, error) {
					updateStatus();
				}
			});
		});   
        
		document.getElementById('updateJailConfigRequestButton').addEventListener('click', function() {
			$.cjax({
				url: `./api/jail`,
				type: 'POST',
                contentType: 'text/html',
                data: document.getElementById('jailconfig').value,
				success: function(data) {
					updateStatus();
				},
				error: function(xhr, status, error) {
					updateStatus();
				}
			});
		});   

        $.ajax({
            url: './api/filter',
            type: 'GET',
            success: function(data) {
                document.getElementById('filterconfig').value = data;
            },
            error: function(xhr, status, error) {
                document.getElementById('filterconfig').value = "Error getting filter config!";
            }
        })
        $.ajax({
            url: './api/jail',
            type: 'GET',
            success: function(data) {
                document.getElementById('jailconfig').value = data;
            },
            error: function(xhr, status, error) {
                document.getElementById('jailconfig').value = "Error getting jail config!";
            }
        })

        document.getElementById('banIPButton').addEventListener('click', function() {
			$.cjax({
				url: `./api/ban`,
				type: 'POST',
                contentType: 'text/html',
                data: document.getElementById('banIpInput').value,
				success: function(data) {
                    document.getElementById('banIpInput').value = "";
                    updateStatus();
				},
				error: function(xhr, status, error) {
                    document.getElementById('banIpInput').value = "";
					updateStatus();
				}
			});
		});

        document.getElementById('unbanIPButton').addEventListener('click', function() {
			$.cjax({
				url: `./api/unban`,
				type: 'POST',
                contentType: 'text/html',
                data: document.getElementById('unbanIpInput').value,
				success: function(data) {
                    document.getElementById('unbanIpInput').value = "";
					updateStatus();
				},
				error: function(xhr, status, error) {
                    document.getElementById('unbanIpInput').value = "";
					updateStatus();
				}
			});
		});

        function updateStatus() {
            $.ajax({
                url: `./api/getstatus`,
                type: 'GET',
                success: function(data) {
                    document.getElementById('statusfield').value = data;
                },
                error: function(xhr, status, error) {
                    document.getElementById('statusfield').value = "Error getting fail2ban status!";
                }
            });
        }

        updateStatus();
	</script>
</body>
</html>